%% dynamicsTest.m
% Script to ensure that curvilinear dynamics are okay
clear
clc
close all

vehicleParams; % Load vehicle params
track = Track(0.8); % Make a track object

tspan = [0 10];
x0 = [0; 0; 0; 1.0]; % start aligned and on centerline with v0 = 1.0 m/s
u = [0; 0.0]; % go straight

[t,x] = ode45(@(t,x)curv_bicycle_dyn(t,x,u,lr,lf), tspan, x0);

s = x(:,1);
e_lat = x(:,2);
e_psi = x(:,3);
v = x(:,4);

plot(t,s,'DisplayName','$s$')
hold on
plot(t,e_lat,'DisplayName','$e_{y}$')
plot(t,e_psi,'DisplayName','$e_{\psi}$')
plot(t,v,'DisplayName','$v$')
hold off
xlabel('time $t','Interpreter','latex')
title('Simplified Bicycle Dynamics','Interpreter','latex')
legend('show','Interpreter','latex')
grid on

function [dx] = curv_bicycle_dyn(t,x,u,lr,lf)
    % Define the ODEs
    accel = u(1);
    delta = u(2);
    
    % Do some PID control
    delta = -K_lat*() -K_

    s = x(1);
    e_lat = x(2);
    e_psi = x(3);
    v = x(4);
   
    beta = atan((lr/(lf+lr))*tan(delta));
    k = 0; % straight line

    ds = v*(cos(e_psi + beta))/(1 - e_lat*k);
    de_lat = v*sin(e_psi + beta);
    de_psi = (v/lf)*sin(beta) - k*ds;
    dv = accel;
    
    dx = [ds;
          de_lat;
          de_psi;
          dv];
end